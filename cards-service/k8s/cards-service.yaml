apiVersion: v1
kind: Secret
metadata:
  name: cards-service-secret
  labels:
    app: cards-service
type: Opaque
stringData:
  DB_USERNAME: "root"
  DB_PASSWORD: "root"
  JWT_SECRET: "change_this_to_same_secret_used_in_auth_service_32_bytes_minimum"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cards-service-config
  labels:
    app: cards-service
data:
  SPRING_PROFILES_ACTIVE: "k8s"
  SERVER_PORT: "2001"
  MANAGEMENT_SERVER_PORT: "8079"
  SPRING_CONFIG_IMPORT: "optional:configtree:/run/secrets/"
  SPRING_CLOUD_VAULT_ENABLED: "false"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cards-service
  labels:
    app: cards-service
    version: v1
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: cards-service
  template:
    metadata:
      labels:
        app: cards-service
        version: v1
    spec:
      terminationGracePeriodSeconds: 30
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      containers:
        - name: cards-service
          image: ctshrikar/cards-service:v3
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 2001
              protocol: TCP
            - name: management
              containerPort: 8079
              protocol: TCP
          envFrom:
            - configMapRef:
                name: cards-service-config
            - secretRef:
                name: cards-service-secret
          # --- Health Probes ---
          livenessProbe:
            httpGet:
              path: /actuator/health/liveness
              port: management
            initialDelaySeconds: 60
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /actuator/health/readiness
              port: management
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          startupProbe:
            httpGet:
              path: /actuator/health
              port: management
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 30
          # --- Resource Limits ---
          resources:
            requests:
              cpu: 200m
              memory: 384Mi
            limits:
              cpu: 500m
              memory: 512Mi
          # --- Security ---
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
---
apiVersion: v1
kind: Service
metadata:
  name: cards-service
  labels:
    app: cards-service
spec:
  type: ClusterIP
  selector:
    app: cards-service
  ports:
    - name: http
      protocol: TCP
      port: 2001
      targetPort: 2001
    - name: management
      protocol: TCP
      port: 8079
      targetPort: 8079
